import streamlit as st
import pandas as pd
import urllib.parse

# üîπ Configura√ß√£o da p√°gina
st.set_page_config(page_title="Cat√°logo de Pe√ßas JDEMITO", layout="wide")

# --- IN√çCIO DO BANNER DE PROPAGANDA SUPERIOR ---
# --- Edite esta se√ß√£o para alterar o banner ---
link_banner_topo = "https://www.amazon.com.br"  # Link de destino do banner
# Use uma imagem de banner que seja larga. Exemplo: 1200x200 pixels
url_imagem_banner_topo = "https://images.g2a.com/1024x400/1x1x0/banners/v1/4f2723a1-f761-4560-a292-11f4435896a2/Amazon-Banner-1180x400-PT.png"
altura_maxima_banner = "90px"  # Altura m√°xima do banner (ex: "80px", "100px")
# --- Fim da se√ß√£o de edi√ß√£o ---

st.markdown(f"""
<a href="{link_banner_topo}" target="_blank">
    <img src="{url_imagem_banner_topo}" style="width: 100%; height: auto; max-height: {altura_maxima_banner}; object-fit: cover; border-radius: 7px;">
</a>
""", unsafe_allow_html=True)
st.markdown("<br>", unsafe_allow_html=True) # Adiciona um espa√ßo abaixo do banner
# --- FIM DO BANNER DE PROPAGANDA SUPERIOR ---


# URL base do reposit√≥rio GitHub onde as imagens est√£o armazenadas
GITHUB_REPO_URL = "https://raw.githubusercontent.com/ArkaltRefrigeracao/app-jdemito/main/"

# Fun√ß√£o para carregar os dados da planilha
@st.cache_data(ttl=60)
def load_data():
    df_placas = pd.read_excel("TESTE 222.xlsx", sheet_name="PLACAS")
    df_pecas = pd.read_excel("TESTE 222.xlsx", sheet_name="PE√áAS22")
    return df_placas, df_pecas

# Carregar os dados da planilha
df_placas, df_pecas = load_data()

# Criar um layout flex√≠vel com colunas
col1, col2, col3 = st.columns([1, 3, 1])

# A coluna da esquerda agora s√≥ tem a logo e o bot√£o
with col1:
    st.image("arkaltfoto.JPG", width=100)
    if st.button("üîÑ Atualizar Dados"):
        st.cache_data.clear()
        st.rerun()

with col2:
    st.markdown("""
        <h1 style='text-align: center;
                   background: linear-gradient(to right, #003366, #0055A4, #666666);
                   -webkit-background-clip: text;
                   color: transparent;'>
            CAT√ÅLOGO DE PE√áAS
        </h1>
    """, unsafe_allow_html=True)
    st.markdown("<h4 style='text-align: center; color: #FFD700;'>Grupo J. Demito</h4>", unsafe_allow_html=True)

# (O resto do c√≥digo continua exatamente o mesmo)

# Padroniza√ß√£o do estilo dos t√≠tulos
titulo_azul_escuro = "font-size:20px; font-weight:bold; color:#003366;"
titulo_azul_claro = "font-size:20px; font-weight:bold; color:#0055A4;"
titulo_cinza_claro = "font-size:20px; font-weight:bold; color:#666666;"

# Criar uma sess√£o de estado para armazenar as sele√ß√µes
if "pecas_selecionadas" not in st.session_state:
    st.session_state.pecas_selecionadas = {}

# Sele√ß√£o do tipo de ve√≠culo
st.markdown(f"<p style='{titulo_azul_escuro}'>üöõ Escolha o tipo de ve√≠culo:</p>", unsafe_allow_html=True)
tipo_veiculo = st.selectbox("", df_placas["TIPO DE VE√çCULO"].unique(), label_visibility="collapsed")

# Sele√ß√£o da placa
st.markdown(f"<p style='{titulo_cinza_claro}'>üöó Escolha a placa:</p>", unsafe_allow_html=True)
placas_filtradas = df_placas[df_placas["TIPO DE VE√çCULO"] == tipo_veiculo]
placa = st.selectbox("", placas_filtradas["PLACA"], label_visibility="collapsed")

# Exibir pe√ßas dispon√≠veis
st.markdown(f"<p style='{titulo_azul_claro}'>üõ†Ô∏è Pe√ßas dispon√≠veis:</p>", unsafe_allow_html=True)
pecas_disponiveis = df_pecas[df_pecas["PLACA"] == placa][["PE√áA", "C√ìDIGO"]].values.tolist()

# Exibi√ß√£o das pe√ßas com caixas de sele√ß√£o e imagens
pecas_selecionadas = st.session_state.pecas_selecionadas.get(placa, set())

for idx, (peca, codigo) in enumerate(pecas_disponiveis):
    unique_key = f"checkbox_{placa}_{idx}"
    selecionado = st.checkbox(f"{peca} (C√≥digo: {codigo})", key=unique_key, value=(codigo in pecas_selecionadas))
    if selecionado:
        pecas_selecionadas.add(codigo)
    else:
        pecas_selecionadas.discard(codigo)
    imagem_url = f"{GITHUB_REPO_URL}{codigo}.jpg"
    st.image(imagem_url, width=180)

st.session_state.pecas_selecionadas[placa] = pecas_selecionadas

# Fun√ß√£o para gerar a mensagem formatada
def gerar_mensagem(tipo_veiculo, placa, pecas_selecionadas):
    mensagem = f"""
    Ol√°, gostaria de um or√ßamento:

    üöó Ve√≠culo: {tipo_veiculo}
    üî¢ Placa: {placa}

    üõ†Ô∏è Pe√ßas solicitadas:
    """
    for codigo in pecas_selecionadas:
        mensagem += f"- C√≥digo: {codigo}\n"
    return mensagem.strip()

# Bot√µes para solicitar or√ßamento
numero_whatsapp1 = "556392930759"
numero_whatsapp2 = "556392099424"

if pecas_selecionadas:
    mensagem_formatada = gerar_mensagem(tipo_veiculo, placa, pecas_selecionadas)
    link_whatsapp1 = f"https://api.whatsapp.com/send?phone={numero_whatsapp1}&text={urllib.parse.quote(mensagem_formatada)}"
    link_whatsapp2 = f"https://api.whatsapp.com/send?phone={numero_whatsapp2}&text={urllib.parse.quote(mensagem_formatada)}"

    st.markdown(f'<a href="{link_whatsapp1}" style="display: block; padding: 10px; text-align: center; background-color: #4A90E2; color: white; text-decoration: none; border-radius: 5px;">üìû Solicitar Or√ßamento (Vendedor Gustavo)</a>', unsafe_allow_html=True)
    st.markdown("<br>", unsafe_allow_html=True)
    st.markdown(f'<a href="{link_whatsapp2}" style="display: block; padding: 10px; text-align: center; background-color: #4A90E2; color: white; text-decoration: none; border-radius: 5px;">üìû Solicitar Or√ßamento (Vendedor Jos√©)</a>', unsafe_allow_html=True)